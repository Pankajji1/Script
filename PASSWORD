<?php
// ======================= [ VPN & Proxy Blocker ] =======================
$API_KEY = 'be3e7968bced4b87b082b5d16a401044'; // ← apni API key yahan daalo (vpnapi.io se)
$BLOCKED_URL = 'https://pankajxscripts.blogspot.com/p/vpn-blocked.html';
$CACHE_DIR = __DIR__ . '/ipcache';
$CACHE_TTL = 3600; // 1 hour cache

if (!is_dir($CACHE_DIR)) @mkdir($CACHE_DIR, 0755, true);

function get_client_ip() {
    $keys = [
        'HTTP_CLIENT_IP','HTTP_X_FORWARDED_FOR','HTTP_X_FORWARDED',
        'HTTP_X_CLUSTER_CLIENT_IP','HTTP_FORWARDED_FOR','HTTP_FORWARDED','REMOTE_ADDR'
    ];
    foreach ($keys as $k) {
        if (!empty($_SERVER[$k])) {
            $ips = explode(',', $_SERVER[$k]);
            return trim($ips[0]);
        }
    }
    return '0.0.0.0';
}

function cache_get($key, $cache_dir, $ttl) {
    $fn = $cache_dir . '/' . md5($key) . '.json';
    if (!file_exists($fn)) return null;
    if (time() - filemtime($fn) > $ttl) { @unlink($fn); return null; }
    $json = file_get_contents($fn);
    return json_decode($json, true);
}

function cache_set($key, $data, $cache_dir) {
    $fn = $cache_dir . '/' . md5($key) . '.json';
    file_put_contents($fn, json_encode($data));
}

function is_non_real_ip($ip, $api_key, $cache_dir, $cache_ttl) {
    $cache = cache_get($ip, $cache_dir, $cache_ttl);
    if ($cache !== null) return (bool)$cache['is_non_real'];

    $url = "https://vpnapi.io/api/{$ip}?key={$api_key}";
    $ch = curl_init($url);
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_CONNECTTIMEOUT => 5,
        CURLOPT_TIMEOUT => 8,
        CURLOPT_USERAGENT => 'ProxyChecker/1.0'
    ]);
    $resp = curl_exec($ch);
    $http = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($http !== 200 || !$resp) return false;

    $data = json_decode($resp, true);
    $sec = $data['security'] ?? [];

    $is_non_real = (
        !empty($sec['vpn']) ||
        !empty($sec['proxy']) ||
        !empty($sec['tor']) ||
        !empty($sec['hosting']) ||
        !empty($sec['anonymous'])
    );

    cache_set($ip, ['is_non_real' => $is_non_real, 'raw' => $data], $cache_dir);
    return $is_non_real;
}

$ip = get_client_ip();
if ($ip !== '127.0.0.1' && $ip !== '::1') {
    if (is_non_real_ip($ip, $API_KEY, $CACHE_DIR, $CACHE_TTL)) {
        header("Location: " . $BLOCKED_URL);
        exit;
    }
}
// =======================================================================


// ======================= [ YOUR ORIGINAL SCRIPT BELOW ] =======================

// URLs array (random URLs add)
$urls = [
    "https://pankajxscripts.blogspot.com/p/your-access-key-amyvdvucvv-copy-created.html",
    "https://pankajxscripts.blogspot.com/p/your-access-key-cpxrgdgbir-copy-created.html",
    "https://pankajxscripts.blogspot.com/p/your-access-key-vmcqizzxpa-copy-created.html",
    "https://pankajxscripts.blogspot.com/p/your-access-key-ryqrdytpqz-copy-created.html",
    "https://pankajxscripts.blogspot.com/p/your-access-key-fgwgmvdnut-copy-created.html",
    "https://pankajxscripts.blogspot.com/p/your-access-key-mrppmwxmmi-copy-created.html",
    "https://pankajxscripts.blogspot.com/p/your-access-key-page3-key-def456-copy_20.html",
    "https://pankajxscripts.blogspot.com/p/your-access-key-page2-key-def455-copy.html",
    "https://pankajxscripts.blogspot.com/p/9.html",
    "https://pankajxscripts.blogspot.com/p/10.html",
    "https://pankajxscripts.blogspot.com/p/11.html",
    "https://pankajxscripts.blogspot.com/p/12.html",
    "https://pankajxscripts.blogspot.com/p/13.html",
    "https://pankajxscripts.blogspot.com/p/14.html",
    "https://pankajxscripts.blogspot.com/p/15.html",
    "https://pankajxscripts.blogspot.com/p/16.html",
    "https://pankajxscripts.blogspot.com/p/17.html",
    "https://pankajxscripts.blogspot.com/p/18.html",
    "https://pankajxscripts.blogspot.com/p/19.html",
    "https://pankajxscripts.blogspot.com/p/20.html",
    "https://pankajxscripts.blogspot.com/p/21.html",
    "https://pankajxscripts.blogspot.com/p/22.html",
    "https://pankajxscripts.blogspot.com/p/23.html",
    "https://pankajxscripts.blogspot.com/p/24.html",
    "https://pankajxscripts.blogspot.com/p/25.html",
    "https://pankajxscripts.blogspot.com/p/26.html",
    "https://pankajxscripts.blogspot.com/p/27.html",
    "https://pankajxscripts.blogspot.com/p/28.html",
    "https://pankajxscripts.blogspot.com/p/29.html",
    "https://pankajxscripts.blogspot.com/p/30.html"
];

// Random URL select
$url = $urls[array_rand($urls)];

// cURL से पेज fetch करना
$ch = curl_init($url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
curl_setopt($ch, CURLOPT_USERAGENT, "PHP Fetch Script");
$response = curl_exec($ch);
curl_close($ch);

// Key निकालना
$Newkey = explode('</div><br>', explode('id="keyBox">🔑 ', $response)[1])[0];

// Shortlink API
$ch = curl_init("https://arlinks.in/api?api=964ff3f2709f625ec592c7504952926c8f2f8ab2&url=" . urlencode($url));
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_HEADER, 0);
$data = curl_exec($ch);
curl_close($ch);

$shortenedUrl = json_decode($data, true)["shortenedUrl"];

// टर्मिनल साफ़ करें
@system(strtoupper(substr(PHP_OS, 0, 3)) === 'WIN' ? "cls" : "clear");

// ANSI कलर
$blue = "\033[1;34m";
$green = "\033[1;32m";
$red = "\033[1;31m";
$reset = "\033[0m";

// ASCII आर्ट
echo $blue . "
  _____                                   
 |  __ \                                  
 | |__) |_ _ ___ _____   _____ _ __ __ _  
 |  ___/ _` / __/ __ \ \ / / _ \ '__/ _` | 
 | |  | (_| \__ \__ \ V /  __/ | | (_| |  
 |_|   \__,_|___/___/ \_/ \___|_|  \__,_|  
\n" . $reset;

// Link print
echo "🔗 Link Password: " . $green . $shortenedUrl . "\n" . $reset;

// Password input
function getPassword() {
    echo "[+] Enter Key: ";
    return trim(fgets(STDIN));
}

// Password check
function checkPassword() {
    global $Newkey;
    $attempt = getPassword();
    if (trim($attempt) === trim($Newkey)) {
        echo "\033[1;32m✅ Password correct!\n\033[0m";
        sleep(1);
        file_put_contents("key", password_hash($Newkey, PASSWORD_BCRYPT));
        return true;
    }
    echo "\033[1;31m❌ Wrong password!\n\033[0m";
    return false;
}

// Expiry time check
$expiryTime = 21600; // 6 hours
$file = "key";
if (file_exists($file) && (time() - filemtime($file) > $expiryTime)) {
    unlink($file);
}

// First password check
if (!checkPassword()) {
    if (file_exists($file)) unlink($file);
    while (!checkPassword()) {
        sleep(1);
    }
}

echo "✅ Access Granted!\n";
